<?php

/**
 * @file
 * Automatically convert saved files to a different format.
 */

/**
 * Implements of hook_menu().
 */
function convertfile_menu() {
  // Create a new category on the admin config page.
  $items['admin/config/convertfile'] = array(
    'title' => 'Convert File',
    'position' => 'left',
    'weight' => -20,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('administer convertfile settings'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  // Provide a page to handle general settings and configuration.
  $items['admin/config/convertfile/settings'] = array(
    'title' => 'Settings',
    'description' => 'Configure Convert File options and settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('convertfile_config_form'),
    'access arguments' => array('administer convertfile settings'),
    'file' => 'convertfile.admin.inc',
    'file path' => drupal_get_path('module', 'convertfile'),
    'weight' => 10,
  );
  $items['admin/config/convertfile/settings/basic'] = array(
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'title' => 'Settings',
  );
  // Provide a page to handle watchdog error messages.
  $items['admin/config/convertfile/settings/watchdog'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Logs',
    'description' => 'View debug and error messages.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('convertfile_watchdog_form'),
    'access arguments' => array('administer convertfile settings'),
    'file' => 'convertfile.admin.inc',
    'file path' => drupal_get_path('module', 'convertfile'),
    'weight' => 20,
  );
  // Provide a page to handle watchdog error messages.
  $items['admin/config/convertfile/settings/handler'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Handlers',
    'description' => 'All installed file conversion handlers.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('convertfile_handler_form'),
    'access arguments' => array('administer convertfile settings'),
    'file' => 'convertfile.admin.inc',
    'file path' => drupal_get_path('module', 'convertfile'),
    'weight' => 30,
  );
  $items['admin/config/convertfile/settings/handler/config'] = array(
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'title' => 'Config',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function convertfile_permission() {
  return array(
    'administer convertfile settings' => array(
      'title' => t('Administer Convert File settings'),
    ),
  );
}

/**
 * Collates all information on conversion providers and supported extensions.
 *
 * @param bool $reset
 *   Bypass all static variables and caching
 *
 * @return array
 *   An assocative array keyed by provider name. Each sub-array contains:
 *   - 'name': (string) Name of the provider.
 *   - 'callback': (string) Name of the callback function.
 *   - 'types': (array) Associative array keyed by file extension that can be
 *     converted to. Value will be the displayed name.
 */
function convertfile_collect_info($reset = FALSE) {
  static $info;

  if (!isset($info) || $reset) {
    if (!$reset && ($cached = cache_get('convertfile_providers', 'cache'))) {
      $info = $cached;
    }
    else {
      $info = module_invoke_all('convertfile_info');
    }
  }

  return $info;
}

/**
 * Implements hook_field_widget_info().
 */
function convertfile_field_widget_info() {
  return array(
    'convertfile_file' => array(
      'label' => t('Convert File'),
      'field types' => array('file'),
      'settings' => array(
        'progress_indicator' => 'throbber',
      ),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_CUSTOM,
        'default value' => FIELD_BEHAVIOR_NONE,
      ),
    ),
    'convertfile_image' => array(
      'label' => t('Convert Image'),
      'field types' => array('image'),
      'settings' => array(
        'progress_indicator' => 'throbber',
        'preview_image_style' => 'thumbnail',
      ),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_CUSTOM,
        'default value' => FIELD_BEHAVIOR_NONE,
      ),
    ),
  );
}

/**
 * Implements hook_element_info().
 *
 * Create convertfile_file type for form api use.
 */
function convertfile_element_info() {
  $file_path = drupal_get_path('module', 'file');
  $types['convertfile_file'] = array(
    '#input' => TRUE,
    '#process' => array('file_managed_file_process'),
    '#value_callback' => 'convertfile_managed_file_value',
    '#element_validate' => array('file_managed_file_validate'),
    '#pre_render' => array('file_managed_file_pre_render'),
    '#theme' => 'file_managed_file',
    '#theme_wrappers' => array('form_element'),
    '#progress_indicator' => 'throbber',
    '#progress_message' => NULL,
    '#upload_validators' => array(),
    '#upload_location' => NULL,
    '#size' => 22,
    '#extended' => FALSE,
    '#attached' => array(
      'css' => array($file_path . '/file.css'),
      'js' => array($file_path . '/file.js'),
    ),
  );

  return $types;
}

/**
 * The #value_callback for a convertfile_file type element.
 */
function convertfile_managed_file_value(&$element, $input = FALSE, $form_state = NULL) {
  // Insert our pseudo field instance parameter.
  $instance = array(
    'widget' => array(
      'settings' => array(
        'convertfile_provider' => 'cf_googledrive',
        'convertfile_format' => 'pdf',
      ),
    ),
  );
  $element['#upload_validators']['convertfile_validate_conversion'] = array($instance);

  return file_managed_file_value($element, $input, $form_state);
}

/**
 * Implements hook_field_widget_settings_form().
 */
function convertfile_field_widget_settings_form($field, $instance) {
  $widget = $instance['widget'];
  $settings = $widget['settings'];

  if ($field['type'] == 'file') {
    $form['progress_indicator'] = array(
      '#type' => 'radios',
      '#title' => t('Progress indicator'),
      '#options' => array(
        'throbber' => t('Throbber'),
        'bar' => t('Bar with progress meter'),
      ),
      '#default_value' => $settings['progress_indicator'],
      '#description' => t('The throbber display does not show the status of uploads but takes up less space. The progress bar is helpful for monitoring progress on large uploads.'),
      '#weight' => 16,
      '#access' => file_progress_implementation(),
    );
  }
  if ($field['type'] == 'image') {
    // Use the file widget settings form.
    $form = file_field_widget_settings_form($field, $instance);
    $form['preview_image_style'] = array(
      '#title' => t('Preview image style'),
      '#type' => 'select',
      '#options' => image_style_options(FALSE),
      '#empty_option' => '<' . t('no preview') . '>',
      '#default_value' => $settings['preview_image_style'],
      '#description' => t('The preview image will be shown while editing the content.'),
      '#weight' => 15,
    );
  }

  // Compile array of all file conversion providers.
  $options = array('none' => '- None -');
  if ($results = convertfile_collect_info()) {
    foreach($results as $key => $result) {
      $options[$key] = $result['name'];
    }
  }

  // Compile list of specific provider's formats.
  $format_options = array('none' => '- None -');
  if (isset($settings['convertfile_provider'])) {
    $handler = $settings['convertfile_provider'];
    if (isset($results[$handler])) {
      foreach($results[$handler]['types'] as $key => $value) {
        $format_options[$key] = $value;
      }
    }
  }

  // O(n^2)
  foreach($results as $key => $provider) {
    foreach($provider['types'] as $key => $type) {
      $format_options[$key] = $type;
    }
  }

  // Add our common custom settings
  $form['convertfile_provider'] = array(
    '#title' => t('Convert using provider'),
    '#type' => 'select',
    '#options' => $options,
    '#default_value' => isset($settings['convertfile_provider']) ? $settings['convertfile_provider'] : 'none',
    '#description' => t('The provider used to convert this file.'),
    '#weight' => 20,
  );

  $form['convertfile_format'] = array(
    '#title' => t('Convert to format'),
    '#type' => 'select',
    '#description' => 'The file format that will be converted to.',
    '#options' => $format_options,
    '#default_value' => isset($settings['convertfile_format']) ? $settings['convertfile_format'] : 'none',
    '#prefix' => "<div id='convertfile-format-wrapper'>",
    '#suffix' => '</div>',
    '#weight' => 22,
  );
  $convertfile_collected_info = json_encode(convertfile_collect_info());
  drupal_add_js(drupal_get_path('module', 'convertfile') . '/js/convert.admin.js');
  drupal_add_js("var convertfile = $convertfile_collected_info", array('type' => 'inline'));
  return $form;
}

/**
 * Implements hook_field_widget_form().
 *
 * Insert a custom validator for any fields managed by our widget.
 */
function convertfile_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {
  $element['#upload_validators']['convertfile_validate_conversion'] = array($instance);
  $element['#upload_validators']['file_validate_extensions'][] = $instance['settings']['file_extensions'];

  if ($field['type'] == 'file') {
    $elements = file_field_widget_form($form, $form_state, $field, $instance, $langcode, $items, $delta, $element);
  }
  if ($field['type'] == 'image') {
    $elements = image_field_widget_form($form, $form_state, $field, $instance, $langcode, $items, $delta, $element);
  }

  return $elements;
}

/**
 * Validator. Will call any registered handlers.
 *
 * In the event of an error the handler should write an error message to
 * $file->convertfile_error.
 *
 * @param stdClass $file
 *   File object that is being readied to be moved from temporary server
 *   upload bin.
 * @param array $instance
 *   Field instance that this file was submitted to.
 *
 * @return array
 *   An empty array on success. Contains at least one element of error message
 *   on failure. This error message will be displayed by drupal_set_message as
 *   this entire function is a validator.
 *
 * @see convertfile_field_widget_form()
 */
function convertfile_validate_conversion($file, $instance) {
  $report = array();
  $settings = $instance['widget']['settings'];

  // Save original information for any checks done after conversion is over.
  $file->convertfile_original = clone $file;

  $info = convertfile_collect_info();
  // If no provider is provided (I.E. None or isset == false), treat the file
  // as a normal upload. Else, actually invoke rules.
  if (isset($settings['convertfile_provider']) && $settings['convertfile_provider'] != "none") {
    $name = $info[$settings['convertfile_provider']]['name'];
    $function = isset($info[$settings['convertfile_provider']]['callback']) ?
      $info[$settings['convertfile_provider']]['callback'] : NULL;

    if ($function && function_exists($function)) {
      // This is not intended for contributed code.
      if (!$function($file, $instance)) {
        $report[] = "File conversion by {$name} callback failed.";
      }
    }
    else {
      // Everything _should be_ rules based.
      rules_invoke_event('convertfile_request', $file, $instance);
      if (isset($file->convertfile_error)) {
        $report[] = "File conversion by {$name} rule failed.";
      }
    }

    // Because the destination was messed with, make sure its still unique.
    $file->destination = file_destination($file->destination, FILE_EXISTS_RENAME);

    // Log successful file conversion.
    if (empty($report)) {
      watchdog('convertfile', "{$name} Saved: {$file->convertfile_original->filename} To: {$file->filename} " . 
        "({$file->destination})", NULL, WATCHDOG_INFO);
      rules_invoke_event('convertfile_success', $file, $instance);
    }
    // Log failed file conversion.
    else {
      watchdog('convertfile', "{$name} Failed to convert {$file->convertfile_original->filename}. {$file->convertfile_error}", NULL, WATCHDOG_ERROR);
      rules_invoke_event('convertfile_failure', $file, $instance);
    }
  }
  return $report;
}

/**
 * Search out and find all fields that use our widgets.
 */
function convertfile_find_widgets($widget, $reset = FALSE) {
  if (!$reset && ($cache = cache_get('convertfile_find_widget_' . $widget, 'cache'))) {
    $data = $cache->data;
  }
  else {
    $data = array();
    $instances = field_info_instances();
    foreach($instances as $entity_key => $entity) {
      foreach($entity as $bundle_key => $bundle) {
        foreach($bundle as $field_key => $field) {
          $type = $field['widget']['type'];
          if ($type == $widget) {
            $data[] = "{$entity_key} : {$bundle_key} : {$field_key}";
          }
        }
      }
    }
    cache_set('convertfile_find_widgets', $data, 'cache');
  }

  return $data;
}

/**
 * Implements hook_help().
 */
function convertfile_help($path, $arg) {
  // If help is empty at end of function then NULL will be returned.
  $help = '';

  // Settings page.
  if ($path == 'admin/config/convertfile/settings') {
    // Help text if rules_admin is not turned on.
    if (!module_exists('rules_admin')) {
      $help .= '<p><a href="/admin/modules">Rules UI</a> (rules_admin) ' . t('module must be enabled to edit or examine the details of rules.') . '</p>';
    }
  }

  // Settings page and all children.
  if (strpos($path, 'admin/config/convertfile/settings') !== FALSE) { 
    // Help text if no handlers have been enabled.
    $handlers = convertfile_collect_info();
    if (empty($handlers)) {
      $help .= '<p>' . t('You must have at least one conversion provider enabled for this module to do anything useful. Visit the <a href="/admin/modules">modules page</a> and enable a conversion provider.') . '</p>';
    }
    // Help text if no widgets have been configured yet.
    $images = convertfile_find_widgets('convertfile_image');
    $files = convertfile_find_widgets('convertfile_file');
    if (empty($images) && empty($files)) {
      $help .= '<p>' . t('Edit a <a href="@convertfile">content type</a> and set a file or image field to use the new <u>Convert File</u> or <u>Convert Image</u> widgets. Include the converted format file extension in the accepted formats field.', array('@convertfile' => url('admin/structure/types'))) . '</p>';
    }
  }

  // Main module help for the convertfile module
  if ($path == 'admin/help#convertfile') {
    $help .= '<p>' . t('Convert File adds a new widget for file and image fields named <u>Convert File</u> and <u>Convert Image</u>. The settings for these widget operate exactly as the default except for providing extra configuration that allow for automatic conversion of the file submitted to the field. See <a href="@convertfile">Convert File Settings</a> for more information.', array('@convertfile' => url('admin/config/convertfile/settings'))) . '</p>';
  }

  return (strlen($help)) ? $help : NULL;
}
